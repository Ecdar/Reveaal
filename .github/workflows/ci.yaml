on:
  - push

name: Validation

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install compiler tools
        run: |
          sudo apt-get update
          sudo apt-get install llvm automake libxml2-dev gperf build-essential libboost-all-dev
      - name: Checkout UDBM
        uses: actions/checkout@v2
        with:
          repository: 'UPPAALModelChecker/UDBM'
          ref: 'cbb68a4a47c04f7e4e68fe78e16ba2069d894a28'
          path: 'udbm'
      - name: Compile UDBM
        run: |
          cd udbm
          cmake -DCMAKE_BUILD_TYPE=Release -S . -B build-Release
          cmake --build build-Release/
      - name: Compile wrapper
        run: |
          cd dbm
          mkdir objectFiles
          cd objectFiles
          ar -x ../../udbm/build-Release/udbm/lib/libbase.a
          ar -x ../../udbm/build-Release/udbm/lib/libdbm.a
          ar -x ../../udbm/build-Release/udbm/lib/libhash.a
          ar -x ../../udbm/build-Release/udbm/lib/libudebug.a
          cd ..
          g++ -c wrapper.cpp -I include/ -o objectFiles/wrapper.o
          ar -rvs libudbmwrapper.a objectFiles/*.o
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: test
          args: -- --test-threads 1

  fmt:
    name: Check code is formatted
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt
      - uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

  check:
    name: Lint and check
    runs-on: ubuntu-latest
    steps:
      - name: Install llvm-config
        run: sudo apt-get install llvm
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: clippy
      - uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
